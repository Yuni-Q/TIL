
# 무정지를 위한 인프라 구조

## 안정성 및 이중화
- 안정성, 고가용성이란, 시스템 서비스가 가능한 멈추지 않도록 하는 것을 말한다.

### 안정성, 고가용성 목표 => 실현수단
- 고장, 장애에 의한 정지가 발생하지 않을 것(하드웨어서는 MTBF라고 한다.) => 컴포넌트 이중화
- 고장, 장애가 발생해도 복구할 수 있을 것(하드웨어에서는 MTTR이라고 한다.) => 컴포넌트 이중화
- 고장, 장애가 발생한 것을 검출할 수 있을 것 => 컴포넌트 감시
- 고장, 장애가 발생해도 데이터가 보호 될 것 => 데이터 백업

### -
- 상용 웹 시스템에서는 ㅇ미들웨어 기능이나 구조로 이중화, 감시, 백업 세 가지 수단을 구현해서 폭표를 실현한다.

### 이중화란?
- 하나의 기능을 병렬로 여러 개 나열해서 하나에 장애가 발생해도 다른 것을 이용ㅇ해서 서비스를 계속할 수 있느 것을 가리킨다.
- 하나의 기능이 병렬로 가동되기 때문에 이런 고가용성에 대한 의미뿐만 아니라 확장성이나 부하분산 같은 성능에 대한 의미도 가진다.

- 모두가 균등하게 가마를 들 수 있는 구조(부하분산)
- 넘어진 사람이 있는지 정기적으로 확인하는 구조(내부적 생존 감시)
- (보충 요원이 있는 경우)스모 선수를 운반하는 사람이 누구인지 판단하는 구조(마스터 결정)
- (보충 요원이 없는 경우)안전한게 요원을 교체할 수 있는 구조(페일오버)

#### 장애보호
- 물리 장애는 H/W(하드웨어) 장애이고, 논리 장애는 데이터 장애다.
- 물리 장애 보호 범위
  1. H/W 컴포넌트 자체 수준의 장애
    - 서버 내 자원이나 팬 자체의 장애를 가리킨다.
    - 이 장애에 어느 정도 견딜 수 있는가를 보여주는 지표가 신뢰성이다.
    - MTBF 값으로 측정한다.
  1. 시스템 서비스 수준의 장애
    - 하나의 서버가 다운되는 장애를 가리킨다.
    - 이 장애에 어느 정도 견딜 수 있는가를 보여 주는 지표가 가용성이다.
    - 이를 위한 대책 중 하나가 이중화다.
  1. 사이트 수준의 장애
    - 데이터 센터의 정전이나 대규모 재해로 인해 발생하는 장애를 가리킨다.
    - 이 장애애에 어느 정도 견딜 수 있는가를 보여 주는 지표가 사업 연속성이다.
    - 이를 우한 대책에는 장애 발생 시의 인원 확보 계획이나 대체 업무 준비, 시스템 지속이나 데이터 보호 검토가 포함된다.
    - 시스쳄 지속이나 데이터 보호 솔루션을 일반적으로 Disater Recovery(DR, 재해 복구)라고 한다.
- 논리 장애의 보호 범위는 거의 비슷하며, 대책으로는 백업이 있다. 저장소 기능 중 하나인 스냅샷은 데이터 복제를 하지 않고 과거 데이터를 참조할 수 있는 논리 백업으로, 진짜 백업이라고 보기는 어렵다.
- DR은 데이터 원격 백업 성격을 가지고 있기 때문에 백업과 비슷하지만 대책 목적이 사이트 장애다.

## 서버 내 이중화

### 전원 장치 등의 이중화
- 랙 뒤쪽의 양 끝에는 전원 탭이 붙어 있다. 양 끝에 있는 이유는 이중화 때문이다.
- 대규모 데이터 센터에서는 각 정원 탭이 별도 분전반이나 UPS(정전 시에 이용하는 대규모 충전지)에 접속돼 있어서 전원 장애에 대비하고 있다.
- 한쪽 전원 탭의 전략만으로 서버가 가동될 수 있도록 소비 전력 합계를 낮추는 것이 중요하다.

### 네트워크 인터페이스 이중화
- PCI 슬롯에 꽂은 카드도 이중화가 가능하다. 네트워크 인터페이스나 파이버채널(FC)포트(케이블 꽂는 곳)에는 이중화 기능이나 이중화를 실현하는 소프트웨어가 있다.
- 네트워크 인터페이스 이중화는 하드웨어 또는 OS로 구현한다.
- 액티브-스탠바이 구성은 마스터-슬레이브 개념에 기반한 것으로, 스탠바이 측은 보통 서비스를 제공하지 않는다. 액티브 측에 어떤 문제가 발생하면 스탠바이 장비로 교체돼서 스챈바이가 액티브로 변경된다. 이렇게 교체ㅏ는 것을 페일오버(failover)라고 한다.
- 네트워크 인터페이스 이중화의 대표적인 구현 방법 중 하나인 리눅스 OS의 본딩(bonding)은 액티브-스탠바이 구성은 액티브-백업이라고 한다. 어떤 인터페이스가 마스터가 되는지는 설정에서 지정할 수 있다.
  - 본딩이 이중화된 인터페이스를 감시하는 방법에는 두 가지가 있다.
    - MII 감시는 MII(Media Independent Interface) 규격에 준거한 인터페이스의 링크 감시로, 현재 주류로 자리잡고 있는 감시 방식이다. MII 검사에서는 링크업(인터페이스가 가동되는 것)이 동작하고 있다면 정상이라고 판단한다.
    - MII 감시가 선호되는 주된 이유
      - 불필요한 폴링 패킷이 전소되지 않는다.
      - 폴링 위치로 지정한 IP 주소를 가진 장비에 대해서는 유지관리나 장애를 의식하지 않아도 된다.
    - ARP 감시는 특정 IP 주소로 ARP 요청을 보내서 돌아오는 응답 유무에 따라 정상적인지를 확인하는 방법.
      - ARP 감시로만 인지할 수 있는 장애도 있다. 임의의 IP 주소에 대해 ARP 요청을 보낼 수 있다. 주로 네트워크 게이트웨이로 요청을 보낸다. 결과적으로 범위가 정상적인지 확인 할 수 있다. 반면에 MII 감시는 인터페이스의 링크 상태를 확인하기 때문에 접소괘 있는 L2 스위치만 감시할 수 있다. APR 감시가 더 넓은 범위를 감시한다는 것을 알 수 있다.
      - ARP 감시에서는 ARP 요청을 정기적으로 실행해서 응답이 있으면 정상이라고 판단한다.
      - ARP 요청은 MAC 주소를 확인하는 브로드캐스트다. 레이어2에서 실시된다.
      - ARP 요청의 단점은 폴리이 되는 ARP 요청이 동일 네트워크 내의 브로트캐스트이기 때문에 불필요한 트래픽이 증가한다는 것이다. 따라서 이 불필욯란 트패픽을 고려해서 감시 빈도를 너무 높게 설정하지 않는 것이 중요하다. ARP 감시는 일반저긍로 1~2초 간격으로 1~2초 간격 정도로 설정한다.(참고로, MII 감시는  0.1 ~ 0.5 정도의 간격으로 설정하는 것이 일반적이다.)
    - 페일오버 구조는 감시 방법에 상관없이 동잉하다.
      - 인터페이스가 페일오버하면 스위치의 MAC 주소 테이블이 변경되고 통신이 재개된다. 이와 같이 네트워크 인터페이스 이중화인 본딩의 구현은 L3 네트워크 계층보다 낮은 계층에서 구현되고 있다. 때문에 장치 이중화 기능이 L7 애플리케이션 계층에서 구현돼 있으면 이상하다라고 판단할 수 있는 감각이 필요하다.

## 저장소 이중화
- 저장소 이중화의 주요 대상은 HDD다.
- 컨트롤러에는 CPU나 캐시가 있어서 HDD I/O 제어를 하고 있다. 실제 HDD는 전용 상자(엔클로저(enclosure)나 쉘프(shelf)라고도 한다)에 담겨 있어서 증설이 용이하다.
- 최근에는 서버와 저장소 사이를 파이버 채널(FC)로 연결하는 SAN(Storage Area Network)이라는 네트워크 구성이 사용되고 있다.
  - SAN에서는 IP 주소 대신에 WWN(World Wide Name)이라는 주소를 이용해서 데이터를 전송한다.
- HDD를 서로 연겨하는 내부 버스를 최근 들어 SAS(Serial Attached SCSI)방식으로 바뀌고 있다.
  - 각 장비에 IN과 OUT 포트가 있어서 계속 따라가다 보면 HDD까지 원형 연결이 만들어지는 것을 알 수 있다.
  - 저장소는 이 원형 연결을 여러 개 준비해서 HDD 액세스 이중화를 도모하고 있다.
- 서버가 저장소를 액세스할 때는 일반적인 액티브-스탠바이 또는 액티브-액티브 방식을 이용한다.
- RAID는 여러 HDD를 묶어서 그룹으로 만들고 이것을 논리적인 HDD로 인식하는 기술이다.
- 논리적 HDD를 LU(Local Unit)라고 한다. 서버가 인식하는 HDD는 이 LU다.
  - RAID 장점
    1. 안정성 확보
      - 데이터 기록을 이중화한다. HDD는 움직이는 부분이 많아서 쉽게 고장 난다. 띠라서 기록 장치를 이중화한다는 것은 매우 중요한 의미를 가진다.
    1. 성능 향상
      - RAID 컨트롤러가 미리 정해 놓은 길이(8KB, 16KB, 32KB 등)로 I/O를 분할해서 복수의 HDD에 대한 병렬로 I/O를 처리를 한다.
      - 이 고정 길이를 RAID의 스트라이프(stripe) 크기라고 부른다.
      - 여러개의 HDD를 병렬로 동시에 동작시키기 때문에 하나의 HDD를 동작시킬 때보다 I/O 처리 성능이 높아진다. 이 특성을 살리려면 하나의 RAID 그룹에 포함하는 HDD수를 늘리면 된다. 대신에 한대의 HDD 고장이 끼치는 영향 범위도 커지기 때문에 상충 관계에 있다고 할 수 있다. 최근에는 I/O 성능 중시 경향이 있어서 하나의 RAID 그룹 크기가 커지고 있다. 8대 ~ 15대 정도가 하나의 그룹을 이룬다.
      - 참고로 RAID 스트라이프의 크기의 최댓값은 해당 시스템의 I/O 측성, 저장소 종류에 따라 달라질 수 있으니 제조사에 문의하도록 하자.
    1. 용량 확장
  - RAID 구성 패턴(RAID1, RAID5, RAID1+0과 같은 구성 패턴이 주류다.)
    - RAID5
      - RAID5는 이중화 확보를 위해 패리티라는 오류 수정 부호를 기록한다.
      - 패리티를 하나의 HDD에 집중시키지 않고 분석하는 것이 특징이다.
      - 패티리 연산이 이루어지기 때문에 RAID1+0에 비해 I/O 성능이 느리다.
      - 이중화 부분이 적고(HDD수 - 1) / HDD 수만큼의 용량을 사용할 수 있다. 용량을 중시하는 경우는 RAID5를 사용하는 것이 좋다.
    - RAID1, RAID1+0
      - RAID1은 일반적으로 OS 디스크 이중화에 사용된다.
      - RAID1+0은 RAID0과 RAID1을 조합한 구성이다. RAID0은 이중화 없이 HDD에 기록하는 방식이다. RAID1+0은 복수에 HDD에 병렬로 이중 기록을 하는 방식이다. 이것은 안정성과 성능을 균형 있게 구성하는 방식이다.
      - 미러링을 하기 때문에 전체 용량의 1/2 용량밖에 사용할 수 없다.
      - HDD가 고장나면 RAID 구성에 포함된 데이터는 망가지지 않지만, 이중호화 구조가 망가진다. 이 이중화 회복을 위해 핫 스페어라고 하느 디스크를 이용한다. 한대의 HDD가 고장 남녀 자동적으로 핫 스페어가 RAID에 포함돼서 이중화 구조를 회복한다. 하지만 핫 스페어가 고갈되고 거기에 HDD까지 파손된 RAID에서는 데이터 손실이 발생하기 때무에 주의가 필요하다.
    - 이와 때문에 RAID에 의존하는 것이 아니라 데이터 백업도 반드시 해 두어야 한다.

### 버스의 이중화

